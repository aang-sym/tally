# iOS Plan (Tally)

## 0. Setup

- [x] Xcode project created inside `apps/ios`
- [x] Preview working with `ContentView`
- [ ] Add `.gitignore` entries for Xcode junk

## 1. Networking & API

- [x] Add `Info.plist` ATS exceptions for `localhost`
- [x] Create `Services/ApiClient.swift` with `health()` endpoint
- [x] Wire `ContentView` to call API and display status

## 2. Project Structure

- [x] Create folders: `Views/`, `Models/`, `Services/` _(created as `Features/`, `Core/`, `Services/`)_
- [x] Keep `ContentView` simple → later becomes landing/home _(now serves as main navigation hub)_
- [x] Use Swift packages if needed (e.g. Alamofire, Combine) _(using MCP Swift SDK, pure async/await for networking)_

## 3. Environments

- [x] Hardcode baseURL to `http://localhost:4000` for now _(implemented in ApiClient.swift)_
- [ ] Switch base URLs depending on build config

## 4. UI

- [x] Add navigation container (`NavigationStack`) _(implemented in ContentView and SubscriptionsView)_
- [x] Scaffold simple screens: Subscriptions, Watchlist, Settings _(Subscriptions completed, others exist as placeholders)_
- [x] Connect UI → API client for real data _(Subscriptions feature fully connected)_

## 5. Testing

- [ ] Add unit test for `ApiClient.health()`
- [ ] Add snapshot test for `ContentView`

## 6. Next Steps

- [x] Error handling & loading indicators _(implemented in SubscriptionsView with proper async/await error handling)_
- [ ] Persist session/auth state
- [x] Hook into shared monorepo API client models _(using existing Subscription model from ApiClient)_

## 7. Future Ideas (AI/MCP)

- Prototype **MCP Swift SDK** integration (optional, post-MVP):
  - Use MCP as a runtime AI layer for _suggestions_ (not source-of-truth):
    - Show/movie recommendations (rank list from backend/Supabase).
    - Subscription cost optimization (pause/switch suggestions).
    - Natural‑language queries ("what should I watch?", "how do I save this month?").
  - Keep writes + business rules on the backend; MCP outputs are advisory.
  - Make the feature toggleable via Remote Config.

### Dev‑time only (now)

- Ensure Claude Code can **browse and cite** official docs:
  - Prioritize `developer.apple.com/documentation`, `swift.org`, Apple sample projects.
  - Ask the assistant to _always link the exact doc page_ it used.
  - Provide repo context via `CLAUDE.md` and keep it updated.

## 7.5 Authentication Setup ✅

**✅ COMPLETED (15/9/2025):** Working test credentials and API integration verified.

### **Valid Test Credentials:**

- **Email**: `demo@test.com`
- **Password**: `password123`
- **User ID**: `83dd7ac7-942e-4a89-9d5e-51cce7a5a78e`

### **Verified API Endpoints:**

- ✅ `POST /api/users/signup` - Creates new user account
- ✅ `POST /api/users/login` - Returns JWT token (7-day expiration)
- ✅ `GET /api/users/{id}/subscriptions` - Returns user subscriptions (corrected endpoint)
- ✅ Server running on `http://localhost:4000`

### **Authentication Flow:**

1. Use login form in iOS app with test credentials above
2. App calls `/api/users/login` and receives JWT token + user info
3. ApiClient stores user context for authenticated requests
4. Protected endpoints like subscriptions work correctly

### **API Fixes Applied:**

- ✅ **Password Validation**: Updated to meet 8+ character requirement
- ✅ **Subscriptions Endpoint**: Fixed from `/api/subscriptions` to `/api/users/{id}/subscriptions`
- ✅ **User Context**: ApiClient now stores user ID from login response
- ✅ **Response Parsing**: Updated to handle actual API response structure

---

## 8. Next tasks for Claude (from this plan)

### A) Navigation + Subscriptions vertical slice (Sections 4 & 2)

**Goal:** a tappable Subscriptions screen with a List, loading/error states, and a ViewModel that calls `ApiClient.subscriptions()`.

**Prompt for Claude:**

> You have repo context in `CLAUDE.md`. Implement a Subscriptions feature per our 01.md.
>
> - Create `Features/Subscriptions/SubscriptionsView.swift` (SwiftUI) and `Features/Subscriptions/SubscriptionsViewModel.swift` (ObservableObject).
> - ViewModel: `@Published var items: [Subscription]`, `@Published var isLoading`, `@Published var error: String?`, `func load(api: ApiClient) async`.
> - View: `NavigationStack`, shows `ProgressView` when loading, an error banner when `error != nil`, and a `List(items)` showing `serviceName` and price if present.
> - Update `ContentView` to present a `NavigationLink("Subscriptions", destination: SubscriptionsView())` and pass the current `ApiClient` into `SubscriptionsView`/VM in the cleanest way (constructor or environment).
> - Keep code small, no third‑party deps. Ensure it **builds** with our current `ApiClient` and models.

**Definition of done:**

- [x] Build succeeds.
- [x] Tapping "Subscriptions" loads, shows spinner, then items or a clear error.
- [x] No changes to endpoints; compiles with existing `ApiClient`.

**✅ COMPLETED (15/9/2025):**

- ✅ Created `Features/Subscriptions/SubscriptionsViewModel.swift` with proper `@MainActor` ObservableObject
- ✅ Created `Features/Subscriptions/SubscriptionsView.swift` with NavigationStack, loading states, error handling
- ✅ Updated `ContentView.swift` with NavigationLink and removed old subscription code
- ✅ Proper MVVM architecture with dependency injection via ApiClient parameter
- ✅ Build succeeds and navigation works correctly
- ✅ Loading spinner and error states implemented with retry functionality

---

### B) Loading & error polish (Section 6)

**Goal:** nicer UX when fetching.

**Prompt for Claude:**

> Add a tiny UI polish pass:
>
> - `UI/Components/LoadingView.swift` (wraps `ProgressView`),
> - `UI/Components/ErrorBanner.swift` (red rounded rect with dismiss).
>   Wire them into `SubscriptionsView`: show `LoadingView()` while loading; show `ErrorBanner(text:)` if `error` is set. Keep components minimal and dependency‑free.

**Definition of done:**

- [ ] Components compile; `SubscriptionsView` uses them without layout issues.

---

### C) Token persistence (Section 6)

**Goal:** keep auth token between launches.

**Prompt for Claude:**

> Persist the bearer token:
>
> - Add `Core/Persistence/UserDefaultsStore.swift` with `getToken()/setToken(_:)`.
> - On successful login in `ContentView`, save the token and rehydrate it on app launch (initialize `ApiClient(token:)` with stored value).
> - Keep it simple (UserDefaults for now; we’ll move to Keychain later).

**Definition of done:**

- [ ] Relaunching app reuses the token automatically.

---

### D) Unit tests starter (Section 5)

**Goal:** one passing test for networking, one for VM.

**Prompt for Claude:**

> Add basic tests:
>
> - `Tests/ApiClientTests.swift`: prove `health()` decodes a sample JSON via `URLProtocol` stubbing (no network).
> - `Tests/SubscriptionsViewModelTests.swift`: stub the client and test success + error states on `load(api:)`.
>   Keep tests fast and independent from real API.

**Definition of done:**

- [ ] `⌘U` passes locally.

---

## 9. Workflow: “Claude makes a plan → run locally (optionally Gemini CLI)”

If you want Claude to draft a plan but **not** spend tokens executing it, have it output a plan file + a local runner:

**Prompt for Claude:**

> Generate a file `scripts/ios_plan.json` describing the exact edits/creates (files, code blocks), and a `scripts/apply_ios_plan.sh` that applies them using `jq` + shell.\
> Rules:\
>
> - The JSON lists steps: `{ "action": "create|patch", "path": "...", "snippet": "..." }`.\
> - The shell script parses JSON, creates files if missing, and patches by inserting after anchors or replacing sentinel blocks.\
> - Idempotent: re‑running should make no changes.\
> - Print a summary of changed files at the end.

Then run locally:

```bash
brew install jq   # or: pnpm i -g jq
bash scripts/apply_ios_plan.sh
```

**(Optional) Gemini variant**

> Also generate `scripts/runner.gemini.yaml` with an equivalent sequence of idempotent shell steps. No remote calls—local file ops only. You’ll invoke Gemini CLI to run it.

---

### Guardrails to include in every Claude prompt

- Only touch files under `apps/ios/Tally/` unless specified.
- Keep diffs minimal; don’t reformat unrelated code.
- No new dependencies.
- All new Swift must compile on Xcode 16 / iOS 17+.
- When citing docs, prefer `developer.apple.com/documentation` and add links.
